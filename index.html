<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Žan Žnidar">
    <title>Colony Counter</title>
    <meta name="description" content="Automatically count colonies from a photo of your Petri dish.">

    <link rel="stylesheet" href="style.css">
</head>
<body>
    <label for="input">Pick your Petri dish: </label>
    <input type="file" id="input" name="input" accept="image/*"/>
    <br>
    <canvas id="canvas" width="1080" height="1080" style="max-height: calc(100vh - 16px);max-width: calc(100vw - 16px);"></canvas>

    <div>
        <p id="outputText"><span id="outputColours"></span><br><span id="outputColonies"></span></p>
    </div>

    
    <div id="settings">
        <label for="check_auto">Auto-detect: </label>
        <input type="checkbox" class="slider" name="check_auto" id="check_auto" checked>

        <!-- div for manual settings (hide them when auto is checked)-->
        <div id="settingsManual" class="hidden">
            <label for="slider_L">Lightness threshold: </label>
            <input type="range" min="0.01" max="0.99" value="0.4" step="0.01" class="slider" name="slider_L" id="slider_L">

            <label for="slider_size">Size threshold: </label>
            <input type="range" min="1" max="100" value="10" step="1" class="slider" name="slider_size" id="slider_size">

            <label for="check_neg">Dark colonies on bright agar?: </label>
            <input type="checkbox" class="slider" name="check_neg" id="check_neg">

            <br>

            <label for="slider_Sx">Circle centre x: </label>
            <input type="range" min="0" max="1080" value="500" step="1" class="slider" name="slider_Sx" id="slider_Sx">

            <label for="slider_Sy">Circle centre y: </label>
            <input type="range" min="0" max="1080" value="500" step="1" class="slider" name="slider_Sy" id="slider_Sy">

            <label for="slider_r">Circle radius: </label>
            <input type="range" min="0" max="500" value="400" step="1" class="slider" name="slider_r" id="slider_r">

            <br>

            <label for="check_HQ">Analyse full-quality image (slow): </label>
            <input type="checkbox" class="slider" name="check_HQ" id="check_HQ">
        </div>
    </div>

    <footer style="color: gray;">
        <p>Author: Žan&nbsp;Žnidar, ©&nbsp;2022<br>
            Source code is available on <a href="https://github.com/zznidar/colony-counter">GitHub</a></p>
    </footer>

    <script src="index.js"></script>
    <script>
        var canvas = document.getElementById('canvas'),
        context = canvas.getContext('2d');
/*
        make_base();

        function make_base() {
            base_image = new Image();
            base_image.src = './img/3.png';
            base_image.onload = function(){
                analyse(this);
            }
        }
*/

        // https://stackoverflow.com/a/6776055
        var input = document.getElementById('input');
        input.addEventListener('change', handleFiles);

        function handleFiles(e) {


                base_image = new Image();
                base_image.src = URL.createObjectURL(e.target.files[0]);
                base_image.onload = function(){
                    URL.revokeObjectURL(base_image.src)
                    check_HQ.checked = false;

                    // Always enable auto-detect when chaning pictures
                    check_auto.checked = true;
                    settings.dispatchEvent(new Event("change"));

                    // Now we don't even need to call other functions as the change event will trigger the analysis.
                }
        }

        // Handle settings changes
        document.getElementById("settings").addEventListener("change", function(e) {
            console.log(e.target.value);
            auto = check_auto.checked;

            if(auto) {
                document.getElementById("settingsManual").classList.add("hidden");
            } else {
                document.getElementById("settingsManual").classList.remove("hidden");

            }

            let sizes = initialise(base_image);
            console.log("Initialised");
            [slider_Sx.max, slider_Sy.max] = [sizes.sirina, sizes.visina];
            slider_r.max = Math.max(sizes.visina, sizes.sirina)>>>1;

            let settings = {
                "S": [slider_Sx.value, slider_Sy.value],
                "r": slider_r.value,
                "dark": check_neg.checked,
                "auto": auto,
                "size": slider_size.value,
                "L": slider_L.value
            };

            let petrijevka = analyse(auto, settings);
            console.log(petrijevka);
            console.log(petrijevka.centre ?? [slider_Sx.value, slider_Sy.value], petrijevka.radius ?? slider_r.value, petrijevka.size ?? slider_size.value);

            [slider_Sx.value, slider_Sy.value] = petrijevka.centre ?? [slider_Sx.value, slider_Sy.value]; // this won't work if [undef, undef]
            slider_r.value = petrijevka.radius ?? slider_r.value;
            slider_size.value = petrijevka.size ?? slider_size.value;
            // set the two colour pickers once they start to exist

            count()

        })

    </script>
</body>
</html>